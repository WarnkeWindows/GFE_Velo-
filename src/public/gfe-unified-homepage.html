<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Good Faith Exteriors - Premium Windows & Doors</title>
    
    <!-- Sentry Error Tracking -->
    <script src="https://browser.sentry-cdn.com/7.0.0/bundle.min.js" crossorigin="anonymous"></script>
    <script>
        Sentry.init({
            dsn: "https://daf10ccaaf2dcea42bc8ab5340f36027@o4509594994868224.ingest.us.sentry.io/4509595014463489",
            environment: "production",
            tracesSampleRate: 1.0
        });
    </script>

    <style>
        :root {
            --gfe-navy: #1A365D;
            --gfe-navy-light: #2D3748;
            --gfe-navy-dark: #1A202C;
            --gfe-gold: #D4AF37;
            --gfe-gold-light: #F6E05E;
            --gfe-gold-dark: #B7791F;
            --gfe-silver: #C0C0C0;
            --gfe-silver-light: #E2E8F0;
            --gfe-silver-dark: #9CA3AF;
            --gfe-success: #48BB78;
            --gfe-error: #F56565;
            --gfe-warning: #ED8936;
            --gfe-white: #FFFFFF;
            --gfe-black: #000000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, var(--gfe-navy) 0%, var(--gfe-navy-light) 100%);
            color: var(--gfe-white);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .gfe-container {
            max-width: 100%;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header Section */
        .gfe-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .gfe-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://static.wixstatic.com/media/10d52d_5eeff8c1bc7048f494c375abde3aae32~mv2.png') center/cover;
            opacity: 0.1;
            z-index: -1;
        }

        .gfe-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .gfe-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .gfe-logo {
            width: 60px;
            height: 60px;
            background: url('https://static.wixstatic.com/media/10d52d_651a76065cb8426294f04e1b7483a3a2~mv2.png') center/contain no-repeat;
        }

        .gfe-brand-text h1 {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--gfe-gold);
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .gfe-brand-text p {
            color: var(--gfe-silver-light);
            font-size: 0.9rem;
        }

        .gfe-header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .gfe-contact-info {
            text-align: right;
            color: var(--gfe-silver-light);
            font-size: 0.9rem;
        }

        .gfe-contact-info strong {
            color: var(--gfe-gold);
            display: block;
            font-size: 1.1rem;
        }

        /* Main Content Area */
        .gfe-main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
            min-height: calc(100vh - 120px);
        }

        /* Hero Section */
        .gfe-hero {
            background: linear-gradient(135deg, rgba(26, 54, 93, 0.9) 0%, rgba(45, 55, 72, 0.9) 100%),
                        url('https://static.wixstatic.com/media/10d52d_a59424b9d5314e54886b4ba6f091075f~mv2.png') center/cover;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .gfe-hero-content {
            max-width: 600px;
            z-index: 1;
        }

        .gfe-hero h2 {
            font-size: 3rem;
            font-weight: bold;
            color: var(--gfe-white);
            margin-bottom: 20px;
            line-height: 1.2;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
        }

        .gfe-hero-highlight {
            color: var(--gfe-gold);
        }

        .gfe-hero p {
            font-size: 1.3rem;
            color: var(--gfe-silver-light);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .gfe-hero-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .gfe-feature {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .gfe-feature h3 {
            color: var(--gfe-gold);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .gfe-feature p {
            color: var(--gfe-silver-light);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .gfe-hero-cta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .gfe-button {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .gfe-button-primary {
            background: linear-gradient(45deg, var(--gfe-gold), var(--gfe-gold-light));
            color: var(--gfe-navy);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .gfe-button-secondary {
            background: transparent;
            color: var(--gfe-gold);
            border: 2px solid var(--gfe-gold);
        }

        .gfe-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
        }

        /* Chat Panel */
        .gfe-chat-panel {
            background: var(--gfe-navy-dark);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .gfe-chat-header {
            background: linear-gradient(135deg, var(--gfe-gold), var(--gfe-gold-dark));
            color: var(--gfe-navy);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gfe-chat-header h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .gfe-chat-header p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .gfe-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 400px;
        }

        .gfe-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        .gfe-message.user {
            background: linear-gradient(135deg, var(--gfe-gold), var(--gfe-gold-light));
            color: var(--gfe-navy);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .gfe-message.assistant {
            background: rgba(255, 255, 255, 0.1);
            color: var(--gfe-white);
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .gfe-message-time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 5px;
        }

        .gfe-chat-input-area {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gfe-quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .gfe-quick-action {
            background: rgba(255, 255, 255, 0.1);
            color: var(--gfe-gold);
            border: 1px solid rgba(212, 175, 55, 0.3);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gfe-quick-action:hover {
            background: var(--gfe-gold);
            color: var(--gfe-navy);
        }

        .gfe-chat-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .gfe-chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--gfe-white);
            font-size: 0.9rem;
            resize: none;
            max-height: 80px;
            min-height: 40px;
        }

        .gfe-chat-input:focus {
            outline: none;
            border-color: var(--gfe-gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }

        .gfe-chat-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .gfe-send-button {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--gfe-gold), var(--gfe-gold-dark));
            color: var(--gfe-navy);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .gfe-send-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }

        .gfe-send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .gfe-typing-indicator {
            display: none;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            max-width: 85%;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .gfe-typing-indicator.active {
            display: block;
        }

        .gfe-typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .gfe-typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gfe-gold);
            animation: typing 1.4s infinite ease-in-out;
        }

        .gfe-typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .gfe-typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: scale(1);
                opacity: 0.7;
            }
            30% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Status Indicators */
        .gfe-status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid var(--gfe-success);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--gfe-success);
        }

        .gfe-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .gfe-main {
                grid-template-columns: 1fr;
            }
            
            .gfe-chat-panel {
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                max-height: 500px;
            }
        }

        @media (max-width: 768px) {
            .gfe-header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .gfe-hero {
                padding: 20px;
            }
            
            .gfe-hero h2 {
                font-size: 2rem;
            }
            
            .gfe-hero-features {
                grid-template-columns: 1fr;
            }
            
            .gfe-hero-cta {
                flex-direction: column;
            }
            
            .gfe-chat-messages {
                max-height: 300px;
            }
        }

        /* Custom scrollbar */
        .gfe-chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .gfe-chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .gfe-chat-messages::-webkit-scrollbar-thumb {
            background: var(--gfe-gold);
            border-radius: 3px;
        }

        .gfe-chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--gfe-gold-dark);
        }

        /* Loading states */
        .gfe-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            border-top-color: var(--gfe-gold);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <!-- Embedded Configuration with Secrets Integration -->
    <script type="application/json" id="gfe-config" style="display: none;">
    {
        "system": {
            "name": "Good Faith Exteriors Master Home",
            "version": "2.0.0",
            "environment": "production"
        },
        "wix": {
            "production": {
                "siteId": "5ec64f41-3f5e-4ba1-b9fc-018d3a8681a4",
                "metaSiteId": "5ec64f41-3f5e-4ba1-b9fc-018d3a8681a4",
                "accountId": "10d52dd8-ec9b-4453-adbc-6293b99af499",
                "clientId": "11c09244-492f-4332-9983-e768db711388"
            },
            "test": {
                "siteId": "1daf6e42-c7ae-4e56-9a0f-24209afd43c2",
                "clientId": "1009ff27-79a5-47c7-8a1d-553542c06569"
            },
            "blocksApp": {
                "appId": "14ce1214-b278-a7e4-1373-00cebd1bef7c",
                "namespace": "@goodfaithexteriors/grid-flow-engine"
            }
        },
        "googleCloud": {
            "projectId": "good-faith-exteriors",
            "projectNumber": "837326026335",
            "region": "us-central1",
            "apiGateway": "https://gfe-api-gateway-aonuaov3.uc.gateway.dev",
            "backendUrl": "https://gfe-backend-837326026335.us-central1.run.app"
        },
        "api": {
            "endpoints": {
                "leads": "/api/leads",
                "quotes": "/api/quotes",
                "products": "/api/products",
                "chat": "/api/chat",
                "aiEstimate": "/api/ai/estimate",
                "pricing": "/api/pricing",
                "health": "/health"
            },
            "secretKeys": {
                "anthropicOrgId": "ANTHROPIC_GFE_ID",
                "anthropicApiKey": "ANTHROPIC_GFE_GEN_USE_API",
                "anthropicWorkspace": "GFE_WORKSPACE_ANTHROPIC_SECRET",
                "backendApiKey": "GFE_BACKEND_API_KEY",
                "apiGatewayKey": "GFE_API_KEY",
                "googleWorkspaceKey": "google_workspace_api_key",
                "openaiKey": "OPENAI_API_KEY",
                "sentryDsn": "SENTRY_DSN"
            }
        },
        "ai": {
            "claude": {
                "model": "claude-sonnet-4-20250514",
                "maxTokens": 20000,
                "temperature": 0.7
            },
            "openai": {
                "model": "gpt-4-turbo-preview",
                "assistantId": "asst_jZBK7NjoaNPzAfPVUwQ2FYfL"
            }
        },
        "collections": {
            "leads": "GFE_Leads",
            "quotes": "GFE_Quotes",
            "products": "GFE_WindowProducts",
            "analytics": "GFE_Analytics",
            "aiEstimations": "GFE_AIEstimations",
            "chatSessions": "GFE_ChatSessions"
        },
        "features": {
            "aiEstimator": "/good-faith-estimator",
            "windowMeasure": "/ai-window-measure",
            "productBrowser": "/window-products",
            "customerPortal": "/customer-portal"
        },
        "contact": {
            "phone": "(651) 416-8669",
            "email": "info@goodfaithexteriors.com",
            "website": "https://goodfaithexteriors.com"
        },
        "branding": {
            "logo": "https://static.wixstatic.com/media/10d52d_651a76065cb8426294f04e1b7483a3a2~mv2.png",
            "logoSquare": "https://static.wixstatic.com/media/10d52d_91ba6fdf18634b31b4ebedf5f0f7f8d3~mv2.png",
            "estimatorIcon": "https://static.wixstatic.com/media/10d52d_d988707487cd498ab95e653e09f5ca4a~mv2.png",
            "windowMeasureIcon": "https://static.wixstatic.com/media/10d52d_1f0bc35da9f64cfaaf3e7bdd0e19e46d~mv2.png"
        }
    }
    </script>
</head>
<body>
    <div class="gfe-container">
        <!-- Header -->
        <header class="gfe-header">
            <div class="gfe-header-content">
                <div class="gfe-brand">
                    <div class="gfe-logo"></div>
                    <div class="gfe-brand-text">
                        <h1>Good Faith Exteriors</h1>
                        <p>Premium Windows & Doors Since 1999</p>
                    </div>
                </div>
                <div class="gfe-header-actions">
                    <div class="gfe-contact-info">
                        <strong>(651) 416-8669</strong>
                        <span>Call for Free Consultation</span>
                    </div>
                    <div class="gfe-status-indicator">
                        <div class="gfe-status-dot"></div>
                        <span>AI Assistant Online</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="gfe-main">
            <!-- Hero Section -->
            <section class="gfe-hero">
                <div class="gfe-hero-content">
                    <h2>Transform Your Home with <span class="gfe-hero-highlight">AI-Powered</span> Window Solutions</h2>
                    <p>Get instant quotes, measurements, and expert recommendations using our advanced AI technology. Experience the future of window replacement today.</p>
                    
                    <div class="gfe-hero-features">
                        <div class="gfe-feature">
                            <h3>ü§ñ AI Window Analysis</h3>
                            <p>Upload photos for instant measurements and accurate quotes powered by advanced AI technology.</p>
                        </div>
                        <div class="gfe-feature">
                            <h3>üí∞ Instant Pricing</h3>
                            <p>Get real-time quotes with our Good Faith Estimator tool - no waiting required.</p>
                        </div>
                        <div class="gfe-feature">
                            <h3>üèÜ 25+ Years Experience</h3>
                            <p>Minnesota's trusted window experts with thousands of satisfied customers.</p>
                        </div>
                        <div class="gfe-feature">
                            <h3>‚ö° Energy Savings</h3>
                            <p>Save up to 30% on energy bills with our premium, energy-efficient windows.</p>
                        </div>
                    </div>

                    <div class="gfe-hero-cta">
                        <button class="gfe-button gfe-button-primary" onclick="navigateToEstimator()">
                            üè† Get Free AI Estimate
                        </button>
                        <button class="gfe-button gfe-button-secondary" onclick="navigateToMeasurement()">
                            üì∏ AI Window Measure
                        </button>
                    </div>
                </div>
            </section>

            <!-- Chat Panel -->
            <aside class="gfe-chat-panel">
                <div class="gfe-chat-header">
                    <h3>AI Window Expert</h3>
                    <p>Ask me anything about windows, doors, or pricing!</p>
                </div>

                <div class="gfe-chat-messages" id="chatMessages">
                    <div class="gfe-message assistant">
                        Welcome to Good Faith Exteriors! üëã I'm your AI Window Expert. I can help you with:
                        <br><br>
                        ‚Ä¢ Instant quotes and pricing üí∞<br>
                        ‚Ä¢ Window measurements from photos üì∏<br>
                        ‚Ä¢ Product recommendations ü™ü<br>
                        ‚Ä¢ Energy efficiency calculations ‚ö°<br>
                        ‚Ä¢ Scheduling consultations üìÖ<br>
                        <br>
                        What can I help you with today?
                        <div class="gfe-message-time">Just now</div>
                    </div>
                </div>

                <div class="gfe-typing-indicator" id="typingIndicator">
                    <div class="gfe-typing-dots">
                        <div class="gfe-typing-dot"></div>
                        <div class="gfe-typing-dot"></div>
                        <div class="gfe-typing-dot"></div>
                    </div>
                </div>

                <div class="gfe-chat-input-area">
                    <div class="gfe-quick-actions">
                        <button class="gfe-quick-action" onclick="sendQuickMessage('Get a quote')">Get Quote</button>
                        <button class="gfe-quick-action" onclick="sendQuickMessage('Window types')">Window Types</button>
                        <button class="gfe-quick-action" onclick="sendQuickMessage('Energy savings')">Energy Savings</button>
                        <button class="gfe-quick-action" onclick="sendQuickMessage('Schedule consultation')">Schedule Visit</button>
                        <button class="gfe-quick-action" onclick="sendQuickMessage('Financing options')">Financing</button>
                    </div>

                    <div class="gfe-chat-input-container">
                        <textarea 
                            id="chatInput" 
                            class="gfe-chat-input" 
                            placeholder="Ask about pricing, windows, energy savings..."
                            rows="1"
                            onkeypress="handleChatKeyPress(event)"
                            oninput="autoResizeInput(this)"
                        ></textarea>
                        <button class="gfe-send-button" id="sendButton" onclick="sendMessage()">
                            Send
                        </button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script>
        class GFEMasterHomePage {
            constructor() {
                this.config = null;
                this.sessionId = this.generateSessionId();
                this.conversationHistory = [];
                this.isProcessing = false;
                this.parentOrigin = '*';
                this.apiClient = null;
                
                this.init();
            }

            async init() {
                console.log('üè† Good Faith Exteriors Master Home initializing...');
                
                try {
                    // Load embedded configuration
                    this.loadConfiguration();
                    
                    // Initialize API client with secrets
                    await this.initializeAPIClient();
                    
                    // Setup parent communication
                    this.setupParentCommunication();
                    
                    // Initialize chat system
                    this.initializeChatSystem();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Test backend connectivity
                    await this.testBackendConnectivity();
                    
                    // Notify parent that iframe is ready
                    this.notifyParent({
                        type: 'GFE_COMPONENT_READY',
                        source: 'gfe-home-page',
                        sessionId: this.sessionId,
                        capabilities: ['lead_capture', 'ai_chat', 'navigation', 'appointment_booking'],
                        timestamp: Date.now()
                    });
                    
                    console.log('‚úÖ Good Faith Exteriors Master Home ready');
                } catch (error) {
                    console.error('‚ùå Initialization failed:', error);
                    this.showSystemError('System initialization failed. Please refresh the page.');
                }
            }

            loadConfiguration() {
                try {
                    const configElement = document.getElementById('gfe-config');
                    if (configElement) {
                        this.config = JSON.parse(configElement.textContent);
                        console.log('üìã Configuration loaded successfully');
                        configElement.remove(); // Remove for security
                    } else {
                        console.warn('‚ö†Ô∏è No configuration found, using defaults');
                        this.config = this.getDefaultConfig();
                    }
                } catch (error) {
                    console.error('‚ùå Failed to load configuration:', error);
                    this.config = this.getDefaultConfig();
                }
            }

            getDefaultConfig() {
                return {
                    googleCloud: {
                        apiGateway: "https://gfe-api-gateway-aonuaov3.uc.gateway.dev",
                        backendUrl: "https://gfe-backend-837326026335.us-central1.run.app"
                    },
                    api: {
                        endpoints: {
                            chat: "/api/chat",
                            leads: "/api/leads",
                            aiEstimate: "/api/ai/estimate"
                        }
                    }
                };
            }

            async initializeAPIClient() {
                this.apiClient = {
                    baseUrl: this.config.googleCloud?.apiGateway || this.config.googleCloud?.backendUrl,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Source': 'gfe-iframe-home',
                        'X-Session-Id': this.sessionId
                    }
                };

                console.log('üîå API Client initialized with base URL:', this.apiClient.baseUrl);
            }

            async testBackendConnectivity() {
                try {
                    const healthCheck = await this.makeAPICall('/health', 'GET');
                    if (healthCheck.ok) {
                        console.log('‚úÖ Backend connectivity verified');
                        this.updateStatusIndicator('online');
                    } else {
                        console.warn('‚ö†Ô∏è Backend health check failed');
                        this.updateStatusIndicator('degraded');
                    }
                } catch (error) {
                    console.error('‚ùå Backend connectivity test failed:', error);
                    this.updateStatusIndicator('offline');
                }
            }

            async makeAPICall(endpoint, method = 'GET', data = null) {
                try {
                    const url = `${this.apiClient.baseUrl}${endpoint}`;
                    const options = {
                        method: method,
                        headers: this.apiClient.headers
                    };

                    if (data && method !== 'GET') {
                        options.body = JSON.stringify(data);
                    }

                    const response = await fetch(url, options);
                    
                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.status} ${response.statusText}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error(`API call to ${endpoint} failed:`, error);
                    throw error;
                }
            }

            updateStatusIndicator(status) {
                const indicator = document.querySelector('.gfe-status-indicator');
                const dot = document.querySelector('.gfe-status-dot');
                const text = indicator.querySelector('span');

                switch (status) {
                    case 'online':
                        indicator.style.borderColor = 'var(--gfe-success)';
                        indicator.style.color = 'var(--gfe-success)';
                        dot.style.background = 'var(--gfe-success)';
                        text.textContent = 'AI Assistant Online';
                        break;
                    case 'degraded':
                        indicator.style.borderColor = 'var(--gfe-warning)';
                        indicator.style.color = 'var(--gfe-warning)';
                        dot.style.background = 'var(--gfe-warning)';
                        text.textContent = 'AI Assistant Limited';
                        break;
                    case 'offline':
                        indicator.style.borderColor = 'var(--gfe-error)';
                        indicator.style.color = 'var(--gfe-error)';
                        dot.style.background = 'var(--gfe-error)';
                        text.textContent = 'AI Assistant Offline';
                        break;
                }
            }

            setupParentCommunication() {
                window.addEventListener('message', (event) => {
                    this.handleParentMessage(event.data);
                });
            }

            handleParentMessage(data) {
                switch (data.type) {
                    case 'GFE_CONNECTION_ACK':
                        console.log('üîó Connection established with parent');
                        this.parentOrigin = data.origin;
                        break;
                    case 'GFE_CONFIG_UPDATE':
                        this.updateConfiguration(data.config);
                        break;
                    case 'GFE_NAVIGATE_REQUEST':
                        this.handleNavigationRequest(data.destination, data.params);
                        break;
                    case 'GFE_CHAT_MESSAGE':
                        this.handleExternalChatMessage(data.message);
                        break;
                }
            }

            notifyParent(message) {
                window.parent.postMessage(message, this.parentOrigin);
            }

            initializeChatSystem() {
                // Auto-resize input handling
                this.setupAutoResize();
                
                // Initialize AI chat session
                this.initializeAIChatSession();
                
                // Track user activity
                this.trackAnalyticsEvent('page_loaded', {
                    page: 'home',
                    timestamp: new Date().toISOString()
                });
            }

            async initializeAIChatSession() {
                try {
                    // Initialize chat session with backend
                    const sessionData = await this.makeAPICall('/api/chat/init', 'POST', {
                        sessionId: this.sessionId,
                        source: 'home_page',
                        timestamp: new Date().toISOString()
                    });

                    console.log('üí¨ Chat session initialized:', sessionData);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Chat session initialization failed, using fallback mode');
                }
            }

            setupEventListeners() {
                // Additional setup for interactive elements
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('gfe-quick-action')) {
                        this.trackAnalyticsEvent('quick_action_clicked', {
                            action: e.target.textContent,
                            sessionId: this.sessionId
                        });
                    }
                });

                // Error handling for the iframe
                window.addEventListener('error', (error) => {
                    console.error('Iframe error:', error);
                    this.trackAnalyticsEvent('error', {
                        message: error.message,
                        filename: error.filename,
                        line: error.lineno
                    });
                });
            }

            setupAutoResize() {
                const input = document.getElementById('chatInput');
                input.addEventListener('input', () => {
                    this.autoResizeInput(input);
                });
            }

            autoResizeInput(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 80) + 'px';
            }

            generateSessionId() {
                return `gfe_session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }

            // Chat System Methods
            async sendMessage() {
                if (this.isProcessing) return;

                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;

                try {
                    this.isProcessing = true;
                    this.disableSendButton();
                    
                    // Add user message to chat
                    this.addMessage('user', message);
                    input.value = '';
                    this.autoResizeInput(input);
                    
                    // Show typing indicator
                    this.showTypingIndicator();
                    
                    // Process message with AI
                    const response = await this.processWithAI(message);
                    
                    // Add AI response
                    this.addMessage('assistant', response.content);
                    
                    // Handle any actions suggested by AI
                    if (response.action) {
                        await this.handleAIAction(response.action, response.actionData);
                    }
                    
                    // Track interaction
                    this.trackAnalyticsEvent('chat_interaction', {
                        userMessage: message.substring(0, 100),
                        sessionId: this.sessionId,
                        messageCount: this.conversationHistory.length
                    });

                } catch (error) {
                    console.error('Chat error:', error);
                    this.addMessage('assistant', 'I apologize, but I encountered an error. Please try again or call us directly at (651) 416-8669 for immediate assistance.');
                } finally {
                    this.hideTypingIndicator();
                    this.enableSendButton();
                    this.isProcessing = false;
                }
            }

            async processWithAI(message) {
                try {
                    // First try backend AI processing
                    const aiResponse = await this.makeAPICall('/api/chat', 'POST', {
                        message: message,
                        sessionId: this.sessionId,
                        conversationHistory: this.conversationHistory.slice(-10), // Last 10 messages for context
                        timestamp: new Date().toISOString()
                    });

                    return {
                        content: aiResponse.response || aiResponse.content,
                        action: aiResponse.action,
                        actionData: aiResponse.actionData
                    };
                } catch (error) {
                    console.warn('Backend AI failed, using fallback processing:', error);
                    return this.fallbackAIProcessing(message);
                }
            }

            fallbackAIProcessing(message) {
                // Fallback AI processing when backend is unavailable
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('quote') || lowerMessage.includes('price') || lowerMessage.includes('cost')) {
                    return {
                        content: `I'd be happy to help you get a quote! üí∞ 
                        
For the most accurate pricing, I recommend our AI-powered Good Faith Estimator. It analyzes your specific needs and provides instant quotes.

Here are your options:
‚Ä¢ **Quick AI Estimate** - Get instant pricing in minutes
‚Ä¢ **Photo Analysis** - Upload window photos for precise measurements
‚Ä¢ **In-Home Consultation** - Schedule a professional assessment

Would you like me to direct you to our estimator tool, or would you prefer to schedule a consultation first?`,
                        action: 'suggest_estimator'
                    };
                }
                
                if (lowerMessage.includes('window') && (lowerMessage.includes('type') || lowerMessage.includes('style'))) {
                    return {
                        content: `Great question! We offer a complete range of premium windows: ü™ü

**Popular Window Types:**
‚Ä¢ **Double-Hung** - Classic style, easy cleaning
‚Ä¢ **Casement** - Maximum ventilation and views  
‚Ä¢ **Bay Windows** - Expanded space and light
‚Ä¢ **Sliding** - Modern, space-saving design
‚Ä¢ **Picture Windows** - Unobstructed views

**Premium Brands Available:**
‚Ä¢ Marvin ‚Ä¢ Andersen ‚Ä¢ Pella ‚Ä¢ Provia ‚Ä¢ Windsor

Each type has different benefits for energy efficiency, maintenance, and aesthetics. What's your home style, and what are your main priorities - energy savings, easy maintenance, or maximum light?`,
                        action: 'show_products'
                    };
                }
                
                if (lowerMessage.includes('energy') || lowerMessage.includes('efficient') || lowerMessage.includes('saving')) {
                    return {
                        content: `Excellent question! Our energy-efficient windows can significantly reduce your utility bills: ‚ö°

**Energy Savings Benefits:**
‚Ä¢ **20-30% reduction** in heating/cooling costs
‚Ä¢ **Triple-pane glass** with Low-E coatings
‚Ä¢ **Argon gas fills** for superior insulation
‚Ä¢ **$150-$400 annual savings** per window (typical)

**Additional Benefits:**
‚Ä¢ Federal tax credits up to $600 available
‚Ä¢ Increased home value
‚Ä¢ Improved comfort year-round
‚Ä¢ Reduced condensation and drafts

Our AI analysis can calculate your specific energy savings based on your current windows and home details. Would you like me to start an energy efficiency assessment?`,
                        action: 'suggest_energy_analysis'
                    };
                }
                
                if (lowerMessage.includes('schedule') || lowerMessage.includes('consultation') || lowerMessage.includes('appointment')) {
                    return {
                        content: `I'd be happy to help you schedule a consultation! üìÖ

**Free In-Home Consultation Includes:**
‚Ä¢ Professional window assessment
‚Ä¢ Detailed measurements and recommendations  
‚Ä¢ Energy efficiency analysis
‚Ä¢ Custom quote presentation
‚Ä¢ Product samples and catalogs

**Available appointment times:**
‚Ä¢ Weekdays: 8 AM - 6 PM
‚Ä¢ Saturdays: 9 AM - 3 PM
‚Ä¢ Evening appointments available

To schedule, I'll need:
‚Ä¢ Your name and contact information
‚Ä¢ Property address
‚Ä¢ Preferred appointment time
‚Ä¢ Brief description of your project

Would you like to provide this information now, or would you prefer I transfer you to our scheduling system?`,
                        action: 'capture_lead'
                    };
                }
                
                if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
                    return {
                        content: `Hello! Welcome to Good Faith Exteriors! üëã 

I'm your AI Window Expert, and I'm here to help you with everything related to windows and doors. With over 25 years of experience serving Minnesota homeowners, we're your trusted local experts.

**I can help you with:**
‚Ä¢ Instant quotes and pricing estimates üí∞
‚Ä¢ Window measurements from photos üì∏  
‚Ä¢ Product recommendations and comparisons ü™ü
‚Ä¢ Energy efficiency calculations ‚ö°
‚Ä¢ Scheduling consultations üìÖ
‚Ä¢ Financing options üí≥

What brings you here today? Are you looking to replace windows, get a quote, or just exploring your options?`
                    };
                }
                
                // Default helpful response
                return {
                    content: `I understand you're asking about "${message}". As your AI Window Expert, I'm here to help! 

**I specialize in:**
‚Ä¢ **Pricing & Quotes** - Instant estimates for your project
‚Ä¢ **Window Selection** - Finding the perfect windows for your home  
‚Ä¢ **Energy Efficiency** - Calculating potential savings
‚Ä¢ **Measurements** - AI-powered photo analysis
‚Ä¢ **Scheduling** - Booking consultations and installations

Could you tell me more about your specific window needs? Are you looking to:
‚Ä¢ Get pricing for window replacement?
‚Ä¢ Learn about energy-efficient options?
‚Ä¢ Schedule a consultation?
‚Ä¢ Analyze existing windows with photos?

I'm here to provide expert guidance every step of the way!`
                };
            }

            async handleAIAction(action, actionData) {
                switch (action) {
                    case 'suggest_estimator':
                        setTimeout(() => {
                            this.addMessage('assistant', 'üöÄ Ready to get your instant quote? Click the "Get Free AI Estimate" button above, or I can walk you through it step by step here in chat. What would you prefer?');
                        }, 1000);
                        break;
                        
                    case 'suggest_measurement':
                        setTimeout(() => {
                            this.addMessage('assistant', 'üì± Click the "AI Window Measure" button above to start analyzing your windows with photos, or let me know if you have questions about the process first!');
                        }, 1000);
                        break;
                        
                    case 'capture_lead':
                        setTimeout(() => {
                            this.startLeadCapture();
                        }, 1000);
                        break;
                        
                    case 'show_products':
                        setTimeout(() => {
                            this.addMessage('assistant', 'ü™ü Would you like me to show you our complete window catalog, or do you have a specific style in mind? I can also direct you to our product browser for detailed comparisons.');
                        }, 1000);
                        break;
                }
            }

            async startLeadCapture() {
                this.addMessage('assistant', `Great! Let me collect your information for scheduling: üìù

**Please provide:**
1. **Full Name:** 
2. **Phone Number:**
3. **Email Address:**
4. **Property Address:**
5. **Best time to call:**
6. **Brief project description:**

You can type all this information in one message, or we can go through it step by step. What works better for you?`);
                
                this.collectingLead = true;
                
                // Track lead capture start
                this.trackAnalyticsEvent('lead_capture_started', {
                    sessionId: this.sessionId,
                    source: 'ai_chat'
                });
            }

            async submitLeadData(leadData) {
                try {
                    const response = await this.makeAPICall('/api/leads', 'POST', {
                        ...leadData,
                        source: 'AI Chat - Home Page',
                        sessionId: this.sessionId,
                        timestamp: new Date().toISOString()
                    });

                    this.addMessage('assistant', `‚úÖ Perfect! I've captured your information and someone from our team will contact you within 24 hours.

**What happens next:**
‚Ä¢ Our window expert will call you to discuss your project
‚Ä¢ We'll schedule a convenient time for a free consultation
‚Ä¢ You'll receive a detailed, written estimate
‚Ä¢ No pressure - just honest expertise and fair pricing

Thank you for choosing Good Faith Exteriors! Is there anything else I can help you with while you wait for our call?`);

                    this.trackAnalyticsEvent('lead_captured', {
                        sessionId: this.sessionId,
                        source: 'ai_chat',
                        leadId: response.leadId
                    });

                } catch (error) {
                    console.error('Lead submission failed:', error);
                    this.addMessage('assistant', `I apologize, but there was an issue submitting your information. Please call us directly at **(651) 416-8669** and mention you spoke with our AI assistant, or try again in a few minutes.

Our team is always ready to help you with your window project!`);
                }
            }

            addMessage(role, content) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `gfe-message ${role}`;
                
                // Format content with line breaks and bold text
                let formattedContent = content
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                messageDiv.innerHTML = `
                    ${formattedContent}
                    <div class="gfe-message-time">${new Date().toLocaleTimeString()}</div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Update conversation history
                this.conversationHistory.push({
                    role: role,
                    content: content,
                    timestamp: new Date().toISOString()
                });
                
                // Animate message appearance
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transform = 'translateY(0)';
                    messageDiv.style.transition = 'all 0.3s ease';
                }, 100);
            }

            showTypingIndicator() {
                document.getElementById('typingIndicator').classList.add('active');
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            hideTypingIndicator() {
                document.getElementById('typingIndicator').classList.remove('active');
            }

            disableSendButton() {
                const button = document.getElementById('sendButton');
                button.disabled = true;
                button.innerHTML = '<div class="gfe-loading"></div>';
            }

            enableSendButton() {
                const button = document.getElementById('sendButton');
                button.disabled = false;
                button.innerHTML = 'Send';
            }

            // Navigation Methods
            navigateToEstimator() {
                this.trackAnalyticsEvent('navigation', { destination: 'estimator' });
                
                this.notifyParent({
                    type: 'GFE_NAVIGATE_TO_ESTIMATOR',
                    source: 'gfe-home-page',
                    sessionId: this.sessionId,
                    userContext: {
                        conversationHistory: this.conversationHistory.slice(-5),
                        sessionData: {}
                    },
                    timestamp: Date.now()
                });

                // Also provide fallback URL navigation
                setTimeout(() => {
                    if (this.config?.features?.aiEstimator) {
                        window.parent.location.href = this.config.features.aiEstimator;
                    }
                }, 500);
            }

            navigateToMeasurement() {
                this.trackAnalyticsEvent('navigation', { destination: 'measurement' });
                
                this.notifyParent({
                    type: 'GFE_NAVIGATE_TO_MEASUREMENT',
                    source: 'gfe-home-page',
                    sessionId: this.sessionId,
                    userContext: {
                        conversationHistory: this.conversationHistory.slice(-5),
                        sessionData: {}
                    },
                    timestamp: Date.now()
                });

                // Fallback navigation
                setTimeout(() => {
                    if (this.config?.features?.windowMeasure) {
                        window.parent.location.href = this.config.features.windowMeasure;
                    }
                }, 500);
            }

            showSystemError(message) {
                this.addMessage('assistant', `‚ö†Ô∏è **System Notice:** ${message}

If you continue to experience issues, please:
‚Ä¢ Call us directly at **(651) 416-8669**
‚Ä¢ Email us at **info@goodfaithexteriors.com**
‚Ä¢ Visit our main website for additional resources

Our team is always ready to assist you with your window project!`);
            }

            // Analytics and Communication
            trackAnalyticsEvent(eventType, eventData) {
                const analyticsData = {
                    event: eventType,
                    eventProperties: eventData,
                    sessionId: this.sessionId,
                    timestamp: new Date().toISOString(),
                    page: 'home',
                    userAgent: navigator.userAgent,
                    deviceType: this.getDeviceType()
                };

                // Send to parent for processing
                this.notifyParent({
                    type: 'GFE_ANALYTICS_EVENT',
                    source: 'gfe-home-page',
                    analyticsData: analyticsData,
                    timestamp: Date.now()
                });

                console.log('üìä Analytics event:', analyticsData);
            }

            getDeviceType() {
                const width = window.innerWidth;
                if (width < 768) return 'mobile';
                if (width < 1024) return 'tablet';
                return 'desktop';
            }
        }

        // Global functions for event handling
        let gfeHome;

        function sendMessage() {
            gfeHome.sendMessage();
        }

        function sendQuickMessage(message) {
            const input = document.getElementById('chatInput');
            input.value = message;
            gfeHome.sendMessage();
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                gfeHome.sendMessage();
            }
        }

        function autoResizeInput(textarea) {
            gfeHome.autoResizeInput(textarea);
        }

        function navigateToEstimator() {
            gfeHome.navigateToEstimator();
        }

        function navigateToMeasurement() {
            gfeHome.navigateToMeasurement();
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            gfeHome = new GFEMasterHomePage();
        });

        // Make globally accessible for debugging
        window.gfeHome = gfeHome;
    </script>
</body>
</html>