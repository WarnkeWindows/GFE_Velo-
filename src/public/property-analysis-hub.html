<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Analysis Hub - Good Faith Exteriors</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1A365D 0%, #2D3748 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .analysis-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
        }
        
        .analysis-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .analysis-header h1 {
            color: #D4AF37;
            margin-bottom: 1rem;
        }
        
        .analysis-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .tab-button {
            background: none;
            border: none;
            color: #ffffff;
            padding: 1rem 2rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: #D4AF37;
            border-bottom-color: #D4AF37;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .analysis-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1.5rem;
        }
        
        .analysis-card h3 {
            color: #D4AF37;
            margin-bottom: 1rem;
        }
        
        .upload-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            margin: 2rem 0;
        }
        
        .analysis-button {
            background: #D4AF37;
            color: #1A365D;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 0.5rem;
        }
        
        .results-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 2rem;
            margin-top: 2rem;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #D4AF37;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="analysis-container">
        <div class="analysis-header">
            <h1>üè† Property Analysis Hub</h1>
            <p>Comprehensive analysis for your property and window projects</p>
        </div>
        
        <div class="analysis-tabs">
            <button class="tab-button active" onclick="switchTab('overview', this)">Overview</button>
            <button class="tab-button" onclick="switchTab('property', this)">Property Analysis</button>
            <button class="tab-button" onclick="switchTab('energy', this)">Energy Efficiency</button>
            <button class="tab-button" onclick="switchTab('recommendations', this)">Recommendations</button>
        </div>
        
        <div id="overview" class="tab-content active">
            <div class="analysis-grid">
                <div class="analysis-card">
                    <h3>üè° Property Overview</h3>
                    <p>Get a comprehensive analysis of your property's current state and potential improvements.</p>
                    <button class="analysis-button" onclick="startAnalysis('property')">Start Analysis</button>
                </div>
                
                <div class="analysis-card">
                    <h3>‚ö° Energy Efficiency</h3>
                    <p>Analyze your current energy efficiency and identify opportunities for improvement.</p>
                    <button class="analysis-button" onclick="startAnalysis('energy')">Check Efficiency</button>
                </div>
                
                <div class="analysis-card">
                    <h3>üîç Window Assessment</h3>
                    <p>Detailed assessment of your current windows and replacement recommendations.</p>
                    <button class="analysis-button" onclick="startAnalysis('windows')">Assess Windows</button>
                </div>
                
                <div class="analysis-card">
                    <h3>üí° AI Recommendations</h3>
                    <p>Get personalized recommendations based on your property analysis.</p>
                    <button class="analysis-button" onclick="startAnalysis('recommendations')">Get Recommendations</button>
                </div>
            </div>
        </div>
        
        <div id="property" class="tab-content">
            <div class="upload-section">
                <h3>üì∏ Upload Property Photos</h3>
                <p>Upload exterior photos of your property for analysis</p>
                <input type="file" id="propertyImages" multiple accept="image/*" style="display: none;" onchange="handlePropertyUpload(event)">
                <button class="analysis-button" onclick="document.getElementById('propertyImages').click()">
                    Choose Photos
                </button>
            </div>
            
            <div class="analysis-grid">
                <div class="analysis-card">
                    <h3>üèóÔ∏è Structural Analysis</h3>
                    <p>Assessment of your property's structural elements</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%" id="structuralProgress"></div>
                    </div>
                </div>
                
                <div class="analysis-card">
                    <h3>üé® Aesthetic Evaluation</h3>
                    <p>Analysis of visual appeal and curb appeal factors</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%" id="aestheticProgress"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="energy" class="tab-content">
            <div class="analysis-grid">
                <div class="analysis-card">
                    <h3>üå°Ô∏è Thermal Efficiency</h3>
                    <p>Analysis of heat loss and thermal performance</p>
                    <button class="analysis-button" onclick="analyzeEfficiency('thermal')">Analyze</button>
                </div>
                
                <div class="analysis-card">
                    <h3>üí∞ Cost Savings</h3>
                    <p>Potential savings from window replacements</p>
                    <button class="analysis-button" onclick="analyzeEfficiency('savings')">Calculate</button>
                </div>
            </div>
        </div>
        
        <div id="recommendations" class="tab-content">
            <div class="analysis-card">
                <h3>üéØ Personalized Recommendations</h3>
                <p>Based on your property analysis, here are our recommendations:</p>
                <div id="recommendationsList">
                    <p>Complete property analysis to see recommendations.</p>
                </div>
            </div>
        </div>
        
        <div class="results-panel" id="resultsPanel">
            <h3>üìä Analysis Results</h3>
            <div id="analysisResults"></div>
        </div>
    </div>
    
    <script>
        let currentTab = 'overview';
        let analysisData = {};
        
        function switchTab(tabName, element) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            if (element) {
                element.classList.add('active');
            }
            
            currentTab = tabName;
        }
        
        async function startAnalysis(type) {
            const resultsPanel = document.getElementById('resultsPanel');
            const resultsDiv = document.getElementById('analysisResults');
            
            resultsPanel.style.display = 'block';
            resultsDiv.innerHTML = `
                <p><strong>Analysis Type:</strong> ${type}</p>
                <p><strong>Status:</strong> Processing...</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%" id="analysisProgress"></div>
                </div>
            `;
            
            try {
                // Start with progress simulation
                let progress = 0;
                const progressBar = document.getElementById('analysisProgress');
                const interval = setInterval(() => {
                    progress += 10;
                    progressBar.style.width = progress + '%';
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                    }
                }, 200);
                
                // Call AI-powered analysis
                const analysisResult = await performAIAnalysis(type);
                
                // Complete the analysis
                completeAnalysis(type, analysisResult);
            } catch (error) {
                console.error('Analysis failed:', error);
                handleAnalysisError(type, error);
            }
        }
        
        async function performAIAnalysis(type) {
            try {
                // Call backend API for AI analysis
                const response = await makeApiCall('/api/ai/property-analysis', 'POST', {
                    analysisType: type,
                    timestamp: new Date().toISOString(),
                    options: {
                        includeRecommendations: true,
                        includeCosting: true,
                        provider: 'anthropic'
                    }
                });
                
                return response;
            } catch (error) {
                console.error('AI analysis failed:', error);
                // Return fallback analysis
                return {
                    analysisType: type,
                    success: false,
                    fallback: true,
                    results: getAnalysisResults(type)
                };
            }
        }
        
        function completeAnalysis(type, analysisResult) {
            const resultsDiv = document.getElementById('analysisResults');
            
            // Send analysis data to parent
            window.parent.postMessage({
                type: 'GFE_SAVE_ANALYSIS',
                source: 'property-analysis-hub',
                data: {
                    analysisType: type,
                    timestamp: new Date().toISOString(),
                    results: analysisResult?.results || getAnalysisResults(type),
                    aiEnhanced: analysisResult?.success || false,
                    recommendations: analysisResult?.recommendations || []
                }
            }, '*');
            
            resultsDiv.innerHTML = `
                <p><strong>Analysis Type:</strong> ${type}</p>
                <p><strong>Status:</strong> ‚úÖ Complete ${analysisResult?.success ? '(AI Enhanced)' : ''}</p>
                <div class="analysis-results">
                    ${analysisResult?.results || getAnalysisResults(type)}
                </div>
            `;
        }
        
        function getAnalysisResults(type) {
            const results = {
                property: '<p><strong>Property Score:</strong> 8.5/10</p><p><strong>Recommendations:</strong> 3 areas for improvement</p>',
                energy: '<p><strong>Efficiency Rating:</strong> B+</p><p><strong>Potential Savings:</strong> $2,400/year</p>',
                windows: '<p><strong>Window Condition:</strong> Fair</p><p><strong>Replacement Priority:</strong> High</p>',
                recommendations: '<p><strong>Top Priority:</strong> Replace 6 windows</p><p><strong>Budget Estimate:</strong> $8,500-$12,000</p>'
            };
            
            return results[type] || '<p>Analysis complete</p>';
        }
        
        function handlePropertyUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const uploadSection = document.querySelector('.upload-section');
            uploadSection.innerHTML = `
                <h3>‚úÖ Photos Uploaded</h3>
                <p>${files.length} photo(s) uploaded successfully</p>
                <button class="analysis-button" onclick="startAnalysis('property')">
                    Start Property Analysis
                </button>
            `;
        }
        
        function analyzeEfficiency(type) {
            startAnalysis(type);
        }
        
        // API Configuration
        const API_CONFIG = {
            backendUrl: 'https://gfe-backend-837326026335.us-central1.run.app',
            timeout: 30000,
            maxRetries: 3
        };

        // Make API call with retry logic
        async function makeApiCall(endpoint, method = 'GET', data = null) {
            const url = `${API_CONFIG.backendUrl}${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                'X-Source': 'property-analysis-hub'
            };

            const options = {
                method,
                headers,
                timeout: API_CONFIG.timeout
            };

            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }

            let lastError;
            for (let attempt = 1; attempt <= API_CONFIG.maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    lastError = error;
                    if (attempt < API_CONFIG.maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    }
                }
            }
            
            throw lastError;
        }

        // Handle analysis errors
        function handleAnalysisError(type, error) {
            const resultsDiv = document.getElementById('analysisResults');
            
            resultsDiv.innerHTML = `
                <p><strong>Analysis Type:</strong> ${type}</p>
                <p><strong>Status:</strong> ‚ùå Error</p>
                <div class="error-message">
                    <p>Analysis failed: ${error.message}</p>
                    <p>Please try again or contact support.</p>
                </div>
            `;
            
            // Send error to parent
            window.parent.postMessage({
                type: 'GFE_ERROR',
                source: 'property-analysis-hub',
                error: {
                    message: error.message,
                    analysisType: type,
                    timestamp: new Date().toISOString()
                }
            }, '*');
        }
        
        // Initialize communication with parent
        window.addEventListener('load', function() {
            window.parent.postMessage({
                type: 'GFE_SYSTEM_READY',
                source: 'property-analysis-hub',
                data: { ready: true }
            }, '*');
        });
    </script>
</body>
</html>