<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Good Faith Exteriors - Premium Windows & Doors</title>
    
    <!-- Sentry Error Tracking -->
    <script src="https://browser.sentry-cdn.com/7.0.0/bundle.min.js" crossorigin="anonymous"></script>
    <script>
        Sentry.init({
            dsn: "https://daf10ccaaf2dcea42bc8ab5340f36027@o4509594994868224.ingest.us.sentry.io/4509595014463489",
            environment: "production",
            tracesSampleRate: 1.0
        });
    </script>

    <style>
        :root {
            --gfe-navy: #1A365D;
            --gfe-navy-light: #2D3748;
            --gfe-navy-dark: #1A202C;
            --gfe-gold: #D4AF37;
            --gfe-gold-light: #F6E05E;
            --gfe-gold-dark: #B7791F;
            --gfe-silver: #C0C0C0;
            --gfe-silver-light: #E2E8F0;
            --gfe-silver-dark: #9CA3AF;
            --gfe-success: #48BB78;
            --gfe-error: #F56565;
            --gfe-warning: #ED8936;
            --gfe-white: #FFFFFF;
            --gfe-black: #000000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, var(--gfe-navy) 0%, var(--gfe-navy-light) 100%);
            color: var(--gfe-white);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .gfe-container {
            max-width: 100%;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header Section */
        .gfe-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .gfe-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .gfe-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .gfe-logo {
            width: 60px;
            height: 60px;
            background: url('https://static.wixstatic.com/media/10d52d_651a76065cb8426294f04e1b7483a3a2~mv2.png') center/contain no-repeat;
        }

        .gfe-brand-text h1 {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--gfe-gold);
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .gfe-brand-text p {
            color: var(--gfe-silver-light);
            font-size: 0.9rem;
        }

        .gfe-header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .gfe-contact-info {
            text-align: right;
            color: var(--gfe-silver-light);
            font-size: 0.9rem;
        }

        .gfe-contact-info strong {
            color: var(--gfe-gold);
            display: block;
            font-size: 1.1rem;
        }

        /* Status Indicator */
        .gfe-status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid var(--gfe-success);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--gfe-success);
        }

        .gfe-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content Area */
        .gfe-main {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
            min-height: calc(100vh - 120px);
        }

        /* Hero Section */
        .gfe-hero {
            background: linear-gradient(135deg, rgba(26, 54, 93, 0.9) 0%, rgba(45, 55, 72, 0.9) 100%);
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .gfe-hero-content {
            max-width: 600px;
            z-index: 1;
        }

        .gfe-hero h2 {
            font-size: 3rem;
            font-weight: bold;
            color: var(--gfe-white);
            margin-bottom: 20px;
            line-height: 1.2;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
        }

        .gfe-hero-highlight {
            color: var(--gfe-gold);
        }

        .gfe-hero p {
            font-size: 1.3rem;
            color: var(--gfe-silver-light);
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .gfe-hero-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .gfe-feature {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .gfe-feature h3 {
            color: var(--gfe-gold);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .gfe-feature p {
            color: var(--gfe-silver-light);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .gfe-hero-cta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .gfe-button {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .gfe-button-primary {
            background: linear-gradient(45deg, var(--gfe-gold), var(--gfe-gold-light));
            color: var(--gfe-navy);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .gfe-button-secondary {
            background: transparent;
            color: var(--gfe-gold);
            border: 2px solid var(--gfe-gold);
        }

        .gfe-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
        }

        .gfe-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Chat Panel */
        .gfe-chat-panel {
            background: var(--gfe-navy-dark);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .gfe-chat-header {
            background: linear-gradient(135deg, var(--gfe-gold), var(--gfe-gold-dark));
            color: var(--gfe-navy);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gfe-chat-header h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .gfe-chat-header p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .gfe-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 400px;
        }

        .gfe-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        .gfe-message.user {
            background: linear-gradient(135deg, var(--gfe-gold), var(--gfe-gold-light));
            color: var(--gfe-navy);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .gfe-message.assistant {
            background: rgba(255, 255, 255, 0.1);
            color: var(--gfe-white);
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .gfe-message-time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 5px;
        }

        .gfe-chat-input-area {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gfe-quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .gfe-quick-action {
            background: rgba(255, 255, 255, 0.1);
            color: var(--gfe-gold);
            border: 1px solid rgba(212, 175, 55, 0.3);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gfe-quick-action:hover {
            background: var(--gfe-gold);
            color: var(--gfe-navy);
        }

        .gfe-chat-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .gfe-chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--gfe-white);
            font-size: 0.9rem;
            resize: none;
            max-height: 80px;
            min-height: 40px;
        }

        .gfe-chat-input:focus {
            outline: none;
            border-color: var(--gfe-gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }

        .gfe-chat-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .gfe-send-button {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--gfe-gold), var(--gfe-gold-dark));
            color: var(--gfe-navy);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .gfe-send-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }

        .gfe-send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .gfe-typing-indicator {
            display: none;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            max-width: 85%;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .gfe-typing-indicator.active {
            display: block;
        }

        .gfe-typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .gfe-typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gfe-gold);
            animation: typing 1.4s infinite ease-in-out;
        }

        .gfe-typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .gfe-typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: scale(1);
                opacity: 0.7;
            }
            30% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading states */
        .gfe-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            border-top-color: var(--gfe-gold);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error States */
        .gfe-error {
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid var(--gfe-error);
            color: var(--gfe-error);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .gfe-main {
                grid-template-columns: 1fr;
            }
            
            .gfe-chat-panel {
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                max-height: 500px;
            }
        }

        @media (max-width: 768px) {
            .gfe-header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .gfe-hero {
                padding: 20px;
            }
            
            .gfe-hero h2 {
                font-size: 2rem;
            }
            
            .gfe-hero-features {
                grid-template-columns: 1fr;
            }
            
            .gfe-hero-cta {
                flex-direction: column;
            }
            
            .gfe-chat-messages {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="gfe-container">
        <!-- Header -->
        <header class="gfe-header">
            <div class="gfe-header-content">
                <div class="gfe-brand">
                    <div class="gfe-logo"></div>
                    <div class="gfe-brand-text">
                        <h1>Good Faith Exteriors</h1>
                        <p>Premium Windows & Doors Since 1999</p>
                    </div>
                </div>
                <div class="gfe-header-actions">
                    <div class="gfe-contact-info">
                        <strong>(651) 416-8669</strong>
                        <span>Call for Free Consultation</span>
                    </div>
                    <div class="gfe-status-indicator" id="statusIndicator">
                        <div class="gfe-status-dot"></div>
                        <span id="statusText">System Loading...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="gfe-main">
            <!-- Hero Section -->
            <section class="gfe-hero">
                <div class="gfe-hero-content">
                    <h2>Transform Your Home with <span class="gfe-hero-highlight">AI-Powered</span> Window Solutions</h2>
                    <p>Get instant quotes, measurements, and expert recommendations using our advanced AI technology. Experience the future of window replacement today.</p>
                    
                    <div class="gfe-hero-features">
                        <div class="gfe-feature">
                            <h3>🤖 AI Window Analysis</h3>
                            <p>Upload photos for instant measurements and accurate quotes powered by advanced AI technology.</p>
                        </div>
                        <div class="gfe-feature">
                            <h3>💰 Instant Pricing</h3>
                            <p>Get real-time quotes with our Good Faith Estimator tool - no waiting required.</p>
                        </div>
                        <div class="gfe-feature">
                            <h3>🏆 25+ Years Experience</h3>
                            <p>Minnesota's trusted window experts with thousands of satisfied customers.</p>
                        </div>
                        <div class="gfe-feature">
                            <h3>⚡ Energy Savings</h3>
                            <p>Save up to 30% on energy bills with our premium, energy-efficient windows.</p>
                        </div>
                    </div>

                    <div class="gfe-hero-cta">
                        <button class="gfe-button gfe-button-primary" id="estimatorButton">
                            🏠 Get Free AI Estimate
                        </button>
                        <button class="gfe-button gfe-button-secondary" id="measurementButton">
                            📸 AI Window Measure
                        </button>
                    </div>
                </div>
            </section>

            <!-- Chat Panel -->
            <aside class="gfe-chat-panel">
                <div class="gfe-chat-header">
                    <h3>AI Window Expert</h3>
                    <p>Ask me anything about windows, doors, or pricing!</p>
                </div>

                <div class="gfe-chat-messages" id="chatMessages">
                    <div class="gfe-message assistant">
                        Welcome to Good Faith Exteriors! 👋 I'm your AI Window Expert. I can help you with:
                        <br><br>
                        • Instant quotes and pricing 💰<br>
                        • Window measurements from photos 📸<br>
                        • Product recommendations 🪟<br>
                        • Energy efficiency calculations ⚡<br>
                        • Scheduling consultations 📅<br>
                        <br>
                        What can I help you with today?
                        <div class="gfe-message-time">Just now</div>
                    </div>
                </div>

                <div class="gfe-typing-indicator" id="typingIndicator">
                    <div class="gfe-typing-dots">
                        <div class="gfe-typing-dot"></div>
                        <div class="gfe-typing-dot"></div>
                        <div class="gfe-typing-dot"></div>
                    </div>
                </div>

                <div class="gfe-chat-input-area">
                    <div class="gfe-quick-actions">
                        <button class="gfe-quick-action" data-message="Get a quote">Get Quote</button>
                        <button class="gfe-quick-action" data-message="Window types">Window Types</button>
                        <button class="gfe-quick-action" data-message="Energy savings">Energy Savings</button>
                        <button class="gfe-quick-action" data-message="Schedule consultation">Schedule Visit</button>
                        <button class="gfe-quick-action" data-message="Financing options">Financing</button>
                    </div>

                    <div class="gfe-chat-input-container">
                        <textarea 
                            id="chatInput" 
                            class="gfe-chat-input" 
                            placeholder="Ask about pricing, windows, energy savings..."
                            rows="1"
                        ></textarea>
                        <button class="gfe-send-button" id="sendButton">
                            Send
                        </button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script>
        class GFEHomePageIframe {
            constructor() {
                this.config = null;
                this.sessionId = `home_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                this.conversationHistory = [];
                this.isProcessing = false;
                this.parentOrigin = '*';
                this.oauthToken = null;
                this.userContext = null;
                
                this.init();
            }

            async init() {
                console.log('🏠 GFE Home Page iframe initializing...');
                
                try {
                    // Setup parent communication
                    this.setupParentCommunication();
                    
                    // Initialize with default config
                    this.config = this.getDefaultConfig();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Initialize OAuth context
                    await this.initializeOAuthContext();
                    
                    // Test backend connectivity
                    await this.testBackendConnectivity();
                    
                    // Notify parent that iframe is ready
                    this.notifyParent({
                        type: 'GFE_COMPONENT_READY',
                        source: 'gfe-home-page',
                        sessionId: this.sessionId,
                        capabilities: ['lead_capture', 'ai_chat', 'navigation', 'oauth_integration'],
                        timestamp: Date.now()
                    });
                    
                    console.log('✅ GFE Home Page iframe ready');
                    this.updateStatus('online', 'AI Assistant Online');
                    
                } catch (error) {
                    console.error('❌ Initialization failed:', error);
                    this.updateStatus('error', 'System Error');
                    this.showError('System initialization failed. Please refresh the page.');
                }
            }

            getDefaultConfig() {
                return {
                    // Google Cloud Backend Services
                    API_GATEWAY_URL: 'https://gfe-api-gateway-aonuaov3.uc.gateway.dev',
                    BACKEND_URL: 'https://gfe-backend-837326026335.us-central1.run.app',
                    PROJECT_ID: 'good-faith-exteriors',
                    PROJECT_NUMBER: '837326026335',
                    
                    // Cloud Run Services
                    CLOUD_SERVICES: {
                        KNOWLEDGE_BASE: 'https://knowledge-base-webhook-837326026335.us-central1.run.app',
                        ANNOTATE_HTTP: 'https://annotate-http-837326026335.us-central1.run.app',
                        VISION_PROCESSING: 'https://annotate-gcs-837326026335.us-central1.run.app'
                    },
                    
                    // Wix Configuration
                    WIX_CONFIG: {
                        SITE_ID: '5ec64f41-3f5e-4ba1-b9fc-018d3a8681a4',
                        CLIENT_ID: '11c09244-492f-4332-9983-e768db711388',
                        META_SITE_ID: '5ec64f41-3f5e-4ba1-b9fc-018d3a8681a4'
                    },
                    
                    // API endpoints
                    API_ENDPOINTS: {
                        CHAT: '/api/chat',
                        LEADS: '/api/leads',
                        AI_ESTIMATE: '/api/ai/estimate',
                        HEALTH: '/health',
                        OAUTH: '/oauth/token'
                    }
                };
            }

            setupParentCommunication() {
                window.addEventListener('message', (event) => {
                    if (event.data && event.data.type) {
                        this.handleParentMessage(event.data);
                    }
                });
            }

            handleParentMessage(message) {
                switch (message.type) {
                    case 'GFE_CONFIG_UPDATE':
                        this.updateConfiguration(message.config);
                        break;
                    case 'GFE_OAUTH_TOKEN':
                        this.setOAuthToken(message.token, message.userContext);
                        break;
                    case 'GFE_HEALTH_CHECK':
                        this.respondToHealthCheck();
                        break;
                    case 'GFE_USER_CONTEXT':
                        this.updateUserContext(message.userContext);
                        break;
                    default:
                        console.log('📨 Unknown message from parent:', message.type);
                }
            }

            notifyParent(message) {
                try {
                    window.parent.postMessage(message, this.parentOrigin);
                } catch (error) {
                    console.error('Failed to notify parent:', error);
                }
            }

            async initializeOAuthContext() {
                // Request OAuth token from parent
                this.notifyParent({
                    type: 'GFE_REQUEST_OAUTH_TOKEN',
                    sessionId: this.sessionId,
                    scopes: ['wix.data.read', 'wix.data.write', 'wix.members.read']
                });
            }

            setOAuthToken(token, userContext) {
                this.oauthToken = token;
                this.userContext = userContext;
                console.log('🔐 OAuth token received and user context set');
                
                // Update headers for API calls
                this.updateAPIHeaders();
            }

            updateAPIHeaders() {
                this.apiHeaders = {
                    'Content-Type': 'application/json',
                    'X-Wix-Site-Id': this.config.WIX_CONFIG.SITE_ID,
                    'X-Wix-Client-Id': this.config.WIX_CONFIG.CLIENT_ID,
                    'X-Project-ID': this.config.PROJECT_ID,
                    'X-Session-Id': this.sessionId
                };

                if (this.oauthToken) {
                    this.apiHeaders['Authorization'] = `Bearer ${this.oauthToken}`;
                }

                if (this.userContext) {
                    this.apiHeaders['X-User-Context'] = JSON.stringify(this.userContext);
                }
            }

            async testBackendConnectivity() {
                try {
                    const response = await this.makeSecureAPICall('/health');
                    console.log('✅ Backend connectivity verified');
                    return response;
                } catch (error) {
                    console.error('❌ Backend connectivity test failed:', error);
                    throw error;
                }
            }

            async makeSecureAPICall(endpoint, method = 'GET', data = null) {
                // Try API Gateway first, then fallback to backend
                const urls = [this.config.API_GATEWAY_URL, this.config.BACKEND_URL];
                
                for (const baseUrl of urls) {
                    try {
                        const url = `${baseUrl}${endpoint}`;
                        const options = {
                            method: method,
                            headers: this.apiHeaders || this.getDefaultHeaders()
                        };
                        
                        if (data && (method === 'POST' || method === 'PUT')) {
                            options.body = JSON.stringify(data);
                        }
                        
                        const response = await fetch(url, options);
                        
                        if (!response.ok) {
                            throw new Error(`API call failed: ${response.status} ${response.statusText}`);
                        }
                        
                        return await response.json();
                    } catch (error) {
                        console.warn(`Failed to call ${baseUrl}:`, error);
                        continue;
                    }
                }
                
                throw new Error('All API endpoints failed');
            }

            getDefaultHeaders() {
                return {
                    'Content-Type': 'application/json',
                    'X-Wix-Site-Id': this.config.WIX_CONFIG.SITE_ID,
                    'X-Project-ID': this.config.PROJECT_ID,
                    'X-Session-Id': this.sessionId
                };
            }

            setupEventListeners() {
                // CTA Buttons
                const estimatorButton = document.getElementById('estimatorButton');
                const measurementButton = document.getElementById('measurementButton');
                
                if (estimatorButton) {
                    estimatorButton.addEventListener('click', () => this.navigateToEstimator());
                }
                
                if (measurementButton) {
                    measurementButton.addEventListener('click', () => this.navigateToMeasurement());
                }
                
                // Chat functionality
                const sendButton = document.getElementById('sendButton');
                const chatInput = document.getElementById('chatInput');
                
                if (sendButton) {
                    sendButton.addEventListener('click', () => this.sendMessage());
                }
                
                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                    
                    chatInput.addEventListener('input', () => this.autoResizeTextarea(chatInput));
                }
                
                // Quick actions
                const quickActions = document.querySelectorAll('.gfe-quick-action');
                quickActions.forEach(action => {
                    action.addEventListener('click', () => {
                        const message = action.getAttribute('data-message');
                        this.sendQuickMessage(message);
                    });
                });
            }

            navigateToEstimator() {
                this.trackAnalytics('navigation_request', { destination: 'estimator' });
                
                this.notifyParent({
                    type: 'GFE_NAVIGATE_TO_ESTIMATOR',
                    source: 'gfe-home-page',
                    sessionId: this.sessionId,
                    userContext: this.userContext,
                    timestamp: Date.now()
                });
            }

            navigateToMeasurement() {
                this.trackAnalytics('navigation_request', { destination: 'measurement' });
                
                this.notifyParent({
                    type: 'GFE_NAVIGATE_TO_MEASUREMENT',
                    source: 'gfe-home-page',
                    sessionId: this.sessionId,
                    userContext: this.userContext,
                    timestamp: Date.now()
                });
            }

            async sendMessage() {
                if (this.isProcessing) return;

                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                
                if (!message) return;

                try {
                    this.isProcessing = true;
                    this.disableSendButton();
                    
                    this.addMessage('user', message);
                    chatInput.value = '';
                    this.autoResizeTextarea(chatInput);
                    
                    this.showTypingIndicator();
                    
                    const response = await this.processWithAI(message);
                    
                    this.addMessage('assistant', response.content);
                    
                    if (response.action) {
                        await this.handleAIAction(response.action, response.actionData);
                    }
                    
                    this.trackAnalytics('chat_interaction', {
                        userMessage: message.substring(0, 100),
                        hasOAuth: !!this.oauthToken,
                        messageCount: this.conversationHistory.length
                    });

                } catch (error) {
                    console.error('Chat error:', error);
                    this.addMessage('assistant', 'I apologize, but I encountered an error. Please try again or call us directly at (651) 416-8669 for immediate assistance.');
                    this.trackAnalytics('chat_error', { error: error.message });
                } finally {
                    this.hideTypingIndicator();
                    this.enableSendButton();
                    this.isProcessing = false;
                }
            }

            sendQuickMessage(message) {
                const chatInput = document.getElementById('chatInput');
                chatInput.value = message;
                this.sendMessage();
            }

            async processWithAI(message) {
                try {
                    const response = await this.makeSecureAPICall(this.config.API_ENDPOINTS.CHAT, 'POST', {
                        message: message,
                        context: this.conversationHistory.slice(-5),
                        sessionId: this.sessionId,
                        userContext: this.userContext
                    });

                    return {
                        content: response.message || this.getDefaultResponse(message),
                        action: response.action,
                        actionData: response.actionData
                    };
                } catch (error) {
                    console.error('AI processing error:', error);
                    return {
                        content: this.getDefaultResponse(message)
                    };
                }
            }

            getDefaultResponse(message) {
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('quote') || lowerMessage.includes('price') || lowerMessage.includes('cost')) {
                    return `I'd be happy to help you get a quote! 💰 
                    
For the most accurate pricing, I recommend our AI-powered Good Faith Estimator. It analyzes your specific needs and provides instant quotes.

Here are your options:
• **Quick AI Estimate** - Get instant pricing in minutes
• **Photo Analysis** - Upload window photos for precise measurements
• **In-Home Consultation** - Schedule a professional assessment

Would you like me to direct you to our estimator tool, or would you prefer to schedule a consultation first?`;
                }
                
                if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
                    return `Hello! Welcome to Good Faith Exteriors! 👋 

I'm your AI Window Expert, and I'm here to help you with everything related to windows and doors. With over 25 years of experience serving Minnesota homeowners, we're your trusted local experts.

**I can help you with:**
• Instant quotes and pricing estimates 💰
• Window measurements from photos 📸  
• Product recommendations and comparisons 🪟
• Energy efficiency calculations ⚡
• Scheduling consultations 📅
• Financing options 💳

What brings you here today? Are you looking to replace windows, get a quote, or just exploring your options?`;
                }
                
                return `I understand you're asking about "${message}". As your AI Window Expert, I'm here to help! 

**I specialize in:**
• **Pricing & Quotes** - Instant estimates for your project
• **Window Selection** - Finding the perfect windows for your home  
• **Energy Efficiency** - Calculating potential savings
• **Measurements** - AI-powered photo analysis
• **Scheduling** - Booking consultations and installations

Could you tell me more about your specific window needs? I'm here to provide expert guidance every step of the way!`;
            }

            async handleAIAction(action, actionData) {
                switch (action) {
                    case 'suggest_estimator':
                        setTimeout(() => {
                            this.addMessage('assistant', '🚀 Ready to get your instant quote? Click the "Get Free AI Estimate" button above, or I can walk you through it step by step here in chat. What would you prefer?');
                        }, 1000);
                        break;
                    case 'capture_lead':
                        this.handleLeadCapture(actionData);
                        break;
                    case 'schedule_consultation':
                        this.handleConsultationScheduling(actionData);
                        break;
                }
            }

            handleLeadCapture(leadData) {
                this.notifyParent({
                    type: 'GFE_LEAD_CAPTURED',
                    data: leadData,
                    sessionId: this.sessionId,
                    userContext: this.userContext,
                    timestamp: Date.now()
                });
            }

            addMessage(role, content) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `gfe-message ${role}`;
                
                let formattedContent = content
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                messageDiv.innerHTML = `
                    ${formattedContent}
                    <div class="gfe-message-time">${new Date().toLocaleTimeString()}</div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                this.conversationHistory.push({
                    role: role,
                    content: content,
                    timestamp: new Date().toISOString()
                });
            }

            showTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.classList.add('active');
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            hideTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.classList.remove('active');
                }
            }

            disableSendButton() {
                const button = document.getElementById('sendButton');
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<div class="gfe-loading"></div>';
                }
            }

            enableSendButton() {
                const button = document.getElementById('sendButton');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = 'Send';
                }
            }

            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 80) + 'px';
            }

            updateStatus(status, text) {
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                if (statusIndicator && statusText) {
                    statusText.textContent = text;
                    
                    // Update colors based on status
                    statusIndicator.className = 'gfe-status-indicator';
                    if (status === 'error') {
                        statusIndicator.style.borderColor = 'var(--gfe-error)';
                        statusIndicator.style.color = 'var(--gfe-error)';
                        statusIndicator.style.background = 'rgba(245, 101, 101, 0.1)';
                    } else if (status === 'warning') {
                        statusIndicator.style.borderColor = 'var(--gfe-warning)';
                        statusIndicator.style.color = 'var(--gfe-warning)';
                        statusIndicator.style.background = 'rgba(237, 137, 54, 0.1)';
                    } else {
                        statusIndicator.style.borderColor = 'var(--gfe-success)';
                        statusIndicator.style.color = 'var(--gfe-success)';
                        statusIndicator.style.background = 'rgba(72, 187, 120, 0.1)';
                    }
                }
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'gfe-error';
                errorDiv.textContent = message;
                
                const container = document.querySelector('.gfe-container');
                container.insertBefore(errorDiv, container.firstChild);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }

            trackAnalytics(event, data) {
                this.notifyParent({
                    type: 'GFE_ANALYTICS_EVENT',
                    event: event,
                    data: {
                        ...data,
                        sessionId: this.sessionId,
                        timestamp: new Date().toISOString(),
                        hasOAuth: !!this.oauthToken,
                        userContext: this.userContext
                    }
                });
            }

            updateConfiguration(config) {
                Object.assign(this.config, config);
                this.updateAPIHeaders();
                console.log('📋 Configuration updated');
            }

            updateUserContext(userContext) {
                this.userContext = userContext;
                this.updateAPIHeaders();
                console.log('👤 User context updated');
            }

            respondToHealthCheck() {
                this.notifyParent({
                    type: 'GFE_HEALTH_RESPONSE',
                    status: 'healthy',
                    timestamp: Date.now(),
                    sessionId: this.sessionId,
                    hasOAuth: !!this.oauthToken,
                    userContext: !!this.userContext
                });
            }
        }

        // Initialize the home page iframe
        const gfeHomePageIframe = new GFEHomePageIframe();
    </script>
</body>
</html>